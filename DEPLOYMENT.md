# MCP ADHD Server - Deployment Guide

This guide provides comprehensive instructions for deploying the MCP ADHD Server in various environments, from development to production.

## Table of Contents

1. [Quick Start](#quick-start)
2. [Development Environment](#development-environment)
3. [Production Deployment](#production-deployment)
4. [Docker Deployment](#docker-deployment)
5. [Cloud Deployment](#cloud-deployment)
6. [Security Configuration](#security-configuration)
7. [Monitoring Setup](#monitoring-setup)
8. [Troubleshooting](#troubleshooting)

## Quick Start

### Prerequisites

- Docker and Docker Compose
- Git
- OpenSSL (for generating secrets)

### 1. Clone and Setup

```bash
git clone https://github.com/adrianwedd/mcp-adhd-server.git
cd mcp-adhd-server

# Generate secure secrets
./scripts/generate-secrets.sh > .env.secrets
```

### 2. Configure Environment

```bash
# Copy and customize environment configuration
cp .env.example .env

# Add the generated secrets to your .env file
cat .env.secrets >> .env

# Edit .env with your specific configuration
nano .env
```

### 3. Start the Application

```bash
# Production deployment
docker-compose up -d

# Development deployment
docker-compose -f docker-compose.yml -f docker-compose.development.yml up -d
```

### 4. Verify Deployment

```bash
# Check health
curl http://localhost:8000/health

# View logs
docker-compose logs -f mcp-server
```

## Development Environment

### Setup Development Environment

```bash
# Use development override
docker-compose -f docker-compose.yml -f docker-compose.development.yml up -d

# Or copy development environment
cp .env.development .env
```

### Development Features

The development environment includes:

- **Auto-reload**: Code changes trigger automatic server restart
- **Debug mode**: Detailed error messages and stack traces
- **Development databases**: Separate databases to avoid conflicts
- **Admin interfaces**: 
  - PgAdmin (PostgreSQL): http://localhost:5050
  - Redis Commander: http://localhost:8081
  - MailHog (email testing): http://localhost:8025

### Development Workflow

```bash
# View development logs
docker-compose logs -f mcp-server

# Run database migrations
docker-compose exec mcp-server alembic upgrade head

# Run tests
docker-compose exec mcp-server pytest

# Access development shell
docker-compose exec mcp-server bash
```

## Production Deployment

### Server Requirements

**Minimum Requirements:**
- CPU: 2 cores
- RAM: 2GB
- Storage: 10GB SSD
- Network: 100Mbps

**Recommended Requirements:**
- CPU: 4 cores
- RAM: 4GB
- Storage: 50GB SSD
- Network: 1Gbps

### Environment Preparation

```bash
# Create production user
sudo useradd -m -s /bin/bash mcpuser
sudo usermod -aG docker mcpuser

# Switch to production user
sudo su - mcpuser

# Clone repository
git clone https://github.com/adrianwedd/mcp-adhd-server.git
cd mcp-adhd-server
```

### Production Configuration

```bash
# Generate production secrets
./scripts/generate-secrets.sh > production-secrets.txt

# Create production environment file
cp .env.example .env

# Edit with production values
nano .env
```

**Critical Production Settings:**

```env
# Production environment
ENVIRONMENT=production
DEBUG=false
LOG_LEVEL=INFO

# Strong secrets (generated by script)
SECRET_KEY=your_generated_secret_key
JWT_SECRET=your_generated_jwt_secret
POSTGRES_PASSWORD=your_generated_db_password

# Production domain
ALLOWED_HOSTS=your-domain.com,api.your-domain.com

# Performance settings
MAX_RESPONSE_TIME_MS=3000
MAX_MEMORY_USAGE_MB=512
```

### Production Deployment

```bash
# Deploy production stack
docker-compose up -d

# Verify deployment
docker-compose ps
docker-compose logs mcp-server

# Run health check
curl http://localhost:8000/health
```

## Docker Deployment

### Build Options

```bash
# Build production image
docker build --target production -t mcp-adhd-server:latest .

# Build with build args
docker build \
  --build-arg BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
  --build-arg VERSION=1.0.0 \
  --build-arg VCS_REF=$(git rev-parse --short HEAD) \
  --target production \
  -t mcp-adhd-server:v1.0.0 .

# Build development image
docker build --target development -t mcp-adhd-server:dev .
```

### Docker Compose Profiles

```bash
# Basic deployment (app + database + redis)
docker-compose up -d

# With monitoring (adds Prometheus + Grafana)
docker-compose --profile monitoring up -d

# With SSL (adds Nginx reverse proxy)
docker-compose --profile ssl up -d

# Full deployment (all services)
docker-compose --profile monitoring --profile ssl up -d
```

### Docker Swarm Deployment

```bash
# Initialize swarm
docker swarm init

# Deploy stack
docker stack deploy -c docker-compose.yml mcp-stack

# Monitor deployment
docker service ls
docker service logs mcp-stack_mcp-server
```

## Cloud Deployment

### AWS Deployment

#### Using AWS ECS

1. **Create ECS Cluster**

```bash
# Create cluster
aws ecs create-cluster --cluster-name mcp-adhd-cluster

# Create task definition
aws ecs register-task-definition --cli-input-json file://aws/task-definition.json

# Create service
aws ecs create-service \
  --cluster mcp-adhd-cluster \
  --service-name mcp-adhd-service \
  --task-definition mcp-adhd-task \
  --desired-count 2
```

2. **Setup RDS and ElastiCache**

```bash
# Create RDS PostgreSQL instance
aws rds create-db-instance \
  --db-instance-identifier mcp-adhd-db \
  --db-instance-class db.t3.micro \
  --engine postgres \
  --master-username mcpuser \
  --master-user-password $DB_PASSWORD

# Create ElastiCache Redis cluster
aws elasticache create-cache-cluster \
  --cache-cluster-id mcp-adhd-redis \
  --cache-node-type cache.t3.micro \
  --engine redis
```

#### Using AWS EKS

```bash
# Create EKS cluster
eksctl create cluster --name mcp-adhd-cluster --region us-west-2

# Deploy application
kubectl apply -f k8s/
```

### Google Cloud Platform

```bash
# Create GKE cluster
gcloud container clusters create mcp-adhd-cluster --num-nodes=3

# Deploy application
kubectl apply -f k8s/

# Create managed database
gcloud sql instances create mcp-adhd-db \
  --database-version=POSTGRES_13 \
  --tier=db-f1-micro \
  --region=us-central1
```

### DigitalOcean

```bash
# Create Kubernetes cluster
doctl kubernetes cluster create mcp-adhd-cluster

# Deploy application
kubectl apply -f k8s/

# Create managed database
doctl databases create mcp-adhd-db \
  --engine pg \
  --version 13 \
  --size db-s-1vcpu-1gb \
  --region nyc3
```

## Security Configuration

### SSL/TLS Setup

#### Using Let's Encrypt with Certbot

```bash
# Install certbot
sudo apt-get install certbot python3-certbot-nginx

# Create nginx configuration
sudo cp nginx/nginx-ssl.conf /etc/nginx/sites-available/mcp-adhd

# Obtain SSL certificate
sudo certbot --nginx -d your-domain.com -d api.your-domain.com

# Enable automatic renewal
sudo crontab -e
# Add: 0 12 * * * /usr/bin/certbot renew --quiet
```

#### Manual SSL Configuration

```bash
# Generate private key
openssl genrsa -out ssl/private.key 2048

# Generate certificate signing request
openssl req -new -key ssl/private.key -out ssl/cert.csr

# Generate self-signed certificate (for testing)
openssl x509 -req -days 365 -in ssl/cert.csr -signkey ssl/private.key -out ssl/cert.pem
```

### Firewall Configuration

```bash
# Ubuntu/Debian with ufw
sudo ufw enable
sudo ufw allow 22/tcp   # SSH
sudo ufw allow 80/tcp   # HTTP
sudo ufw allow 443/tcp  # HTTPS
sudo ufw deny 8000/tcp  # Block direct access to app

# CentOS/RHEL with firewalld
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### Security Headers

Add to nginx configuration:

```nginx
add_header X-Content-Type-Options nosniff;
add_header X-Frame-Options DENY;
add_header X-XSS-Protection "1; mode=block";
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
add_header Content-Security-Policy "default-src 'self'";
add_header Referrer-Policy "strict-origin-when-cross-origin";
```

## Monitoring Setup

### Prometheus Configuration

Create `monitoring/prometheus.yml`:

```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'mcp-adhd-server'
    static_configs:
      - targets: ['mcp-server:8000']
    metrics_path: '/metrics'
    scrape_interval: 10s

  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres_exporter:9187']

  - job_name: 'redis'
    static_configs:
      - targets: ['redis_exporter:9121']
```

### Grafana Dashboards

```bash
# Start monitoring stack
docker-compose --profile monitoring up -d

# Import ADHD-specific dashboard
curl -X POST \
  http://admin:${GRAFANA_PASSWORD}@localhost:3000/api/dashboards/db \
  -H "Content-Type: application/json" \
  -d @monitoring/dashboards/adhd-performance.json
```

### Log Aggregation

```bash
# Add ELK stack to monitoring
docker-compose -f docker-compose.yml -f docker-compose.monitoring.yml up -d

# Configure log shipping
docker-compose exec mcp-server \
  filebeat -e -c /etc/filebeat/filebeat.yml
```

## Backup Strategy

### Database Backup

```bash
# Create backup script
cat > scripts/backup-db.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/backup/postgres"
DATE=$(date +%Y%m%d_%H%M%S)
docker-compose exec -T postgres pg_dump -U mcpuser mcp_adhd > $BACKUP_DIR/backup_$DATE.sql
find $BACKUP_DIR -name "backup_*.sql" -mtime +7 -delete
EOF

chmod +x scripts/backup-db.sh

# Schedule backups
crontab -e
# Add: 0 2 * * * /path/to/mcp-adhd-server/scripts/backup-db.sh
```

### Application Data Backup

```bash
# Backup application data
docker-compose exec -T mcp-server tar -czf - /app/data > backup_data_$(date +%Y%m%d).tar.gz

# Backup configuration
tar -czf backup_config_$(date +%Y%m%d).tar.gz .env docker-compose.yml nginx/
```

## Troubleshooting

### Common Issues

#### Application Won't Start

```bash
# Check logs
docker-compose logs mcp-server

# Check environment variables
docker-compose exec mcp-server env | grep -E "DATABASE_URL|REDIS_URL"

# Test database connection
docker-compose exec postgres psql -U mcpuser -d mcp_adhd -c "SELECT 1;"
```

#### High Response Times

```bash
# Check ADHD performance metrics
curl http://localhost:8000/metrics | grep adhd

# Monitor resource usage
docker stats

# Check database performance
docker-compose exec postgres psql -U mcpuser -d mcp_adhd -c "
SELECT query, mean_time, calls 
FROM pg_stat_statements 
ORDER BY mean_time DESC LIMIT 10;"
```

#### Memory Issues

```bash
# Check memory usage
docker-compose exec mcp-server cat /proc/meminfo

# Adjust memory limits in docker-compose.yml
services:
  mcp-server:
    deploy:
      resources:
        limits:
          memory: 1G
```

### Performance Tuning

#### ADHD-Specific Optimizations

```bash
# Tune for <3s response times
export MAX_RESPONSE_TIME_MS=3000
export MAX_COGNITIVE_PROCESSING_MS=1000
export MAX_PATTERN_MATCH_MS=100

# Optimize database connections
export DATABASE_POOL_SIZE=20
export DATABASE_MAX_OVERFLOW=30

# Redis optimization
export REDIS_MAXMEMORY=512mb
export REDIS_MAXMEMORY_POLICY=allkeys-lru
```

#### Database Tuning

```sql
-- PostgreSQL performance tuning
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET effective_cache_size = '1GB';
ALTER SYSTEM SET random_page_cost = 1.1;
ALTER SYSTEM SET max_connections = 100;
SELECT pg_reload_conf();
```

### Health Check Debugging

```bash
# Manual health check
curl -v http://localhost:8000/health

# Detailed health status
curl http://localhost:8000/health | jq .

# Component-specific health
curl http://localhost:8000/health | jq '.components.database'
```

### Support

For additional support:

1. Check the [GitHub Issues](https://github.com/adrianwedd/mcp-adhd-server/issues)
2. Review the [ADHD Performance Guide](TESTING.md#adhd-performance-testing)
3. Consult the [Architecture Documentation](MCP_ARCHITECTURE.md)

## Version History

- **v1.0.0**: Initial production release with comprehensive deployment support
- **v0.9.0**: Beta release with Docker support
- **v0.8.0**: Alpha release with basic deployment